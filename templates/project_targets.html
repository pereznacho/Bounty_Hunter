<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Targets - {{ project.name }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: #c9d1d9;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}
body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background:
        radial-gradient(circle at 20% 30%, rgba(14,165,164,0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(255,184,107,0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(159,216,214,0.03) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.8} }

.container { position: relative; z-index: 10; max-width: 1200px; margin: 24px auto; padding: 40px 20px; color: #c9d1d9; }
.grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }

.card {
    background: #0f1720;
    border: 1px solid #21262d;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 16px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);
    cursor: pointer; transition: all .3s ease; position: relative; backdrop-filter: blur(10px);
}
.card::before { content: ''; position: absolute; top:0; left:0; right:0; height:1px; background: linear-gradient(90deg,transparent,#0ea5a4,transparent); opacity:0; transition: opacity .3s ease; }
.card:hover { transform: translateY(-4px); border-color:#0ea5a4; box-shadow: 0 20px 40px rgba(0,0,0,.5), 0 0 0 1px rgba(14,165,164,.2); }
.card:hover::before { opacity: 1; }

.card h4 { margin: 0 0 12px 0; background: linear-gradient(135deg,#0ea5a4 0%,#9fd8d6 50%,#ffb86b 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.1rem; font-weight: 600; }
.muted { color:#8b949e; font-size:.9rem; margin-bottom: 16px; }
.target-url { display:block; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-family: monospace; font-size:.9rem; color:#facc15; }

.btn { background: linear-gradient(135deg,#0ea5a4 0%,#9fd8d6 100%); color:#0d1117; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-block; transition:all .2s ease; font-size:.9rem; }
.btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(14,165,164,.3); }
.btn-outline { background: transparent; border:1px solid #21262d; color:#9fd8d6; padding:11px 19px; border-radius:8px; cursor:pointer; transition:all .2s ease; text-decoration:none; display:inline-block; font-size:.9rem; }
.btn-outline:hover { border-color:#0ea5a4; background: rgba(14,165,164,.1); }
.btn-danger { background: linear-gradient(135deg,#dc2626,#ef4444) !important; color:#fff !important; border:1px solid #dc2626 !important; }
.btn-danger:hover { background: linear-gradient(135deg,#b91c1c,#dc2626) !important; box-shadow:0 6px 20px rgba(220,38,38,.3) !important; }

/* Cards con vulnerabilidades */
.card.has-vulnerabilities { border-color:#dc2626; background: linear-gradient(135deg, rgba(220,38,38,.1) 0%, #0f1720 50%); animation: pulse-alert 2s ease-in-out infinite; }
.card.has-vulnerabilities::before { background: linear-gradient(90deg,transparent,#dc2626,transparent); opacity:.8; }
.card.has-vulnerabilities:hover { border-color:#ef4444; box-shadow: 0 20px 40px rgba(220,38,38,.3), 0 0 0 1px rgba(220,38,38,.4); }

.card.vuln-critical { border-left:6px solid #8b5cf6; background: linear-gradient(135deg, rgba(139,92,246,.05), rgba(124,58,237,.1)); }
.card.vuln-high     { border-left:6px solid #ef4444; background: linear-gradient(135deg, rgba(239,68,68,.05), rgba(220,38,38,.1)); }
.card.vuln-medium   { border-left:6px solid #f97316; background: linear-gradient(135deg, rgba(249,115,22,.05), rgba(234,88,12,.1)); }
.card.vuln-low      { border-left:6px solid #059669; background: linear-gradient(135deg, rgba(5,150,105,.05), rgba(4,120,87,.1)); }

@keyframes pulse-alert {
    0%,100%{ box-shadow: 0 16px 32px rgba(0,0,0,.4), 0 0 0 1px rgba(220,38,38,.2); }
    50%    { box-shadow: 0 16px 32px rgba(220,38,38,.2), 0 0 0 1px rgba(220,38,38,.4); }
}

/* Badge de vulnerabilidades */
.vuln-badge {
    position:absolute; top:12px; right:12px; padding:4px 8px; border-radius:12px;
    font-size:.75rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px;
    box-shadow:0 2px 4px rgba(0,0,0,.2); color:#fff; animation: pulse-badge 1.5s ease-in-out infinite;
}
.vuln-badge.critical { background: linear-gradient(135deg,#8b5cf6,#7c3aed); border:1px solid #a855f7; }
.vuln-badge.high     { background: linear-gradient(135deg,#ef4444,#dc2626); border:1px solid #f87171; }
.vuln-badge.medium   { background: linear-gradient(135deg,#f97316,#ea580c); border:1px solid #fb923c; }
.vuln-badge.low      { background: linear-gradient(135deg,#059669,#047857); border:1px solid #10b981; }

.has-vulnerabilities.vuln-critical { border-left:6px solid #8b5cf6; background: linear-gradient(135deg, rgba(139,92,246,.05), rgba(124,58,237,.1)); }
.has-vulnerabilities.vuln-high     { border-left:6px solid #ef4444; background: linear-gradient(135deg, rgba(239,68,68,.05), rgba(220,38,38,.1)); }
.has-vulnerabilities.vuln-medium   { border-left:6px solid #f97316; background: linear-gradient(135deg, rgba(249,115,22,.05), rgba(234,88,12,.1)); }
.has-vulnerabilities.vuln-low      { border-left:6px solid #059669; background: linear-gradient(135deg, rgba(5,150,105,.05), rgba(4,120,87,.1)); }

@keyframes pulse-badge { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

/* Animaciones (idÃ©nticas a dashboard) */
@keyframes vulnerability-alert {
    0%{transform:scale(1); border-color:rgba(148,163,184,.2);}  
    25%{transform:scale(1.02); border-color:rgba(239,68,68,.6);} 
    50%{transform:scale(1.05); border-color:rgba(239,68,68,.8);} 
    75%{transform:scale(1.02); border-color:rgba(239,68,68,.6);} 
    100%{transform:scale(1); border-color:rgba(148,163,184,.2);} 
}
@keyframes pulse-update { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:.8; transform:scale(1.01);} }
    </style>
</head>
<body>
<div class="container">
    <div id="banner" class="mb-6">
        <pre class="text-sm leading-none">
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
 â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ•”â•      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
 â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•      â•šâ•â•       â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•
        </pre>
        <p class="subtitle text-center text-gray-400">BugBounty Program: <strong>{{ project.name }}</strong></p>
        <div class="topbar flex items-center justify-end space-x-4 mt-2 text-sm text-white">
            {% if request.session.user_id %}
                <span class="flex items-center space-x-2">
                    <span class="text-white">ğŸ‘¤ {{ request.session.username }}</span>
                    <a href="/logout" class="text-blue-400 hover:underline">Logout</a>
                </span>
            {% else %}
                <a href="/login" class="text-blue-400 hover:underline mr-2">Login</a>
                <a href="/register" class="text-blue-400 hover:underline">Register</a>
            {% endif %}
        </div>
    </div>

    <div style="margin-bottom: 22px; display: flex; gap: 12px; align-items: center; justify-content: space-between;">
        <a href="/dashboard" class="btn-outline">â¬…ï¸ Back to Dashboard</a>
        <form action="/project/{{ project.id }}/delete" method="post" style="margin: 0;" 
              onsubmit="return confirm('âš ï¸ Are you sure you want to delete the ENTIRE bounty program \'{{ project.name }}\'? This will delete ALL targets and their results. This action cannot be undone.')">
            <button type="submit" class="btn-outline btn-danger">ğŸ—‘ï¸ Delete Program</button>
        </form>
    </div>

    <h2 style="color:#9fd8d6; font-size:1.2rem; margin-bottom:12px;">ğŸ¯ Targets in this Program</h2>

    {% if targets %}
    <div class="grid">
        {% for t in targets %}
        <div class="card {% if t.has_vulnerabilities %}has-vulnerabilities vuln-{{ t.vulnerability_level }}{% endif %}"
             data-target-id="{{ t.id }}"
             data-has-vulns="{{ t.has_vulnerabilities|lower }}"
             data-vuln-level="{{ t.vulnerability_level }}"
             data-unviewed="{{ t.has_unviewed_vulnerabilities|lower }}">
            <!-- Dashboard-like severity badge -->
            {% if t.has_vulnerabilities %}
                <div class="vuln-badge {{ t.vulnerability_level }}">
                    {% if t.vulnerability_level == 'critical' %}ğŸš¨ CRITICAL
                    {% elif t.vulnerability_level == 'high' %}âš ï¸ HIGH
                    {% elif t.vulnerability_level == 'medium' %}âš¡ MEDIUM
                    {% elif t.vulnerability_level == 'low' %}ğŸ’¡ LOW
                    {% else %}ğŸ” FINDINGS
                    {% endif %}
                </div>
            {% endif %}

            <div onclick="markVulnerabilityViewed({{ t.id }}); location.href='/project/{{ project.id }}/target/{{ t.id }}';" style="cursor:pointer;">
                <h4 class="target-url">{{ t.target }}</h4>
                <p class="muted">ğŸ§­ Type: {{ t.type }}</p>
                <p class="muted">ğŸ“… Created: {{ t.created_at.strftime('%Y-%m-%d') }}</p>
                <p class="muted">ğŸ“Š Status: 
                    {% if t.status == 'completed' %}
                        <span style="color:#00ff99;">âœ… Completed</span>
                    {% elif t.status == 'running' %}
                        <span style="color:#ffaa00;">ğŸš€ Running</span>
                    {% else %}
                        <span style="color:#cccccc;">â³ {{ t.status }}</span>
                    {% endif %}
                </p>

                <!-- Dashboard-style vulnerability info -->
                {% if t.has_vulnerabilities %}
                    <p class="muted" style="color: #dc2626; font-weight: 600; margin-top: 8px;">
                        ğŸ”¥ Vulnerabilities detected!
                    </p>
                {% endif %}
            </div>

            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: space-between;">
                <a href="/project/{{ project.id }}/target/{{ t.id }}"
                   class="btn {% if t.has_unviewed_vulnerabilities %}btn-danger{% endif %}"
                   style="flex: 1;"
                   onclick="markVulnerabilityViewed({{ t.id }});">
                    {% if t.has_unviewed_vulnerabilities %}
                        ğŸ”¥ View Vulnerabilities
                    {% else %}
                        ğŸ” View Details
                    {% endif %}
                </a>
                <form action="/project/{{ project.id }}/target/{{ t.id }}/delete" method="post" style="margin: 0;" 
                      onsubmit="return confirm('Are you sure you want to delete this target? This will stop any running scan for this target and remove all its results.')">
                    <button type="submit" class="btn btn-danger">ğŸ—‘ï¸</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
        <!-- Show when no targets -->
    <div class="card" style="text-align: center; padding: 40px;">
        <h4 style="color:#f59e0b; margin-bottom: 16px;">ğŸ“­ No Targets in this Program</h4>
        <p class="muted" style="margin-bottom: 8px;"><strong>Bounty Program:</strong> {{ project.name }}</p>
        <p class="muted" style="margin-bottom: 24px;">All targets have been removed from this bounty program. You can delete the entire program since it's empty.</p>
        
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <a href="/dashboard" class="btn-outline">â¬…ï¸ Back to Dashboard</a>
            <form action="/project/{{ project.id }}/delete" method="post" style="margin: 0;" 
                  onsubmit="return confirm('ğŸ—‘ï¸ Delete Empty Program?\n\nProgram: {{ project.name }}\n\nThis will permanently delete this empty bounty program. This action cannot be undone.')">
                <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete Empty Program</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// --- Monitoring variables and helpers ---
let vulnerabilityCheckInterval;
let progressInterval;
const LAST_REQ_TS = Object.create(null);

function markVulnerabilityViewed(targetId) {
    // Mark vulnerability as viewed via AJAX
    fetch(`/target/${targetId}/mark-vulnerability-viewed`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => {
        if (response.ok) {
            console.log('Vulnerability alert marked as viewed');
        }
    }).catch(error => {
        console.error('Error marking vulnerability as viewed:', error);
    });
}

// Simple vulnerability monitoring system like dashboard.html
function checkVulnerabilityStatus() {
    const pid = {{ project.id|safe }};
    fetch(`/api/project/${pid}/vulnerability-status`)
        .then(r => r.json())
        .then(data => {
            (data.targets || []).forEach(ts => {
                const card = document.querySelector(`[data-target-id="${ts.id}"]`);
                if (!card) return;

                // Normalize fields from backend (level/max_severity/vulnerability_level)
                const levelRaw = (ts.level || ts.max_severity || ts.vulnerability_level || '').toString().toLowerCase();
                const hasVulns = Boolean(ts.hasVulnerabilities || ts.has_vulnerabilities);
                const alertViewed = Boolean(ts.alertViewed || ts.alert_viewed || ts.viewed);

                // Helper to ensure a badge exists
                let badge = card.querySelector('.vuln-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'vuln-badge';
                    card.appendChild(badge);
                }

                // Reset classes first
                card.classList.remove('has-vulnerabilities', 'vuln-critical', 'vuln-high', 'vuln-medium', 'vuln-low');

                if (hasVulns && !alertViewed) {
                    const lvl = ['critical','high','medium','low'].includes(levelRaw) ? levelRaw : 'low';

                    // Update badge (match dashboard look)
                    badge.className = `vuln-badge ${lvl}`;
                    badge.innerHTML = ({
                        critical: 'ğŸš¨ CRITICAL',
                        high: 'âš ï¸ HIGH',
                        medium: 'âš¡ MEDIUM',
                        low: 'ğŸ’¡ LOW'
                    })[lvl];
                    badge.style.display = 'block';

                    // Apply dashboard-style card coloring by level
                    card.classList.add('has-vulnerabilities', `vuln-${lvl}`);
                } else {
                    // Hide badge if no active alert
                    badge.style.display = 'none';
                    card.classList.remove('has-vulnerabilities');
                }
            });
        })
        .catch(err => console.error('Error checking vulnerability status:', err));
}

// --- Helpers copied from dashboard to unify visuals ---
function getBadgeContent(level) {
    switch(level) {
        case 'critical': return 'ğŸš¨ CRITICAL';
        case 'high': return 'âš ï¸ HIGH';
        case 'medium': return 'âš¡ MEDIUM';
        case 'low': return 'ğŸ’¡ LOW';
        default: return 'ğŸ” FINDINGS';
    }
}

function getGlowColor(level) {
    switch(level) {
        case 'critical': return 'rgba(239, 68, 68, 0.5)';
        case 'high': return 'rgba(245, 158, 11, 0.5)';
        case 'medium': return 'rgba(59, 130, 246, 0.5)';
        case 'low': return 'rgba(34, 197, 94, 0.5)';
        default: return 'rgba(107, 114, 128, 0.5)';
    }
}

function showVulnerabilityNotification(card, level) {
    // Efecto de pulso y glow
    card.style.animation = 'vulnerability-alert 2s ease-in-out';
    card.style.boxShadow = `0 0 20px ${getGlowColor(level)}`;
    setTimeout(() => { card.style.animation = ''; card.style.boxShadow = ''; }, 2000);

    // NotificaciÃ³n del navegador
    if ('Notification' in window && Notification.permission === 'granted') {
        const targetName = card.querySelector('.target-url')?.textContent || 'Target';
        new Notification('ğŸš¨ Nueva Vulnerabilidad Detectada', {
            body: `Se detectÃ³ una vulnerabilidad ${level.toUpperCase()} en ${targetName}`,
            icon: '/static/favicon.ico'
        });
    }
}

// ---- Monitoring initializers (single source of truth) ----
function initVulnerabilityMonitoring() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    checkVulnerabilityStatus();                 // estado inicial
    vulnerabilityCheckInterval = setInterval(checkVulnerabilityStatus, 10000); // cada 10s
}

// ------- Live Progress Updater (no-op here if cards lack data-project-id) -------
function applyProgressToCard(card, pct, stage) {
    const textEl = card.querySelector('.progress-text');
    const stageEl = card.querySelector('.progress-stage');
    const barEl  = card.querySelector('progress.progress-bar');
    pct = Math.max(0, Math.min(100, Number(pct) || 0));
    if (textEl) textEl.textContent = pct.toString();
    if (barEl)  barEl.value = pct;
    if (stageEl) stageEl.textContent = stage ? `(${stage})` : '';
}

async function refreshProgress() {
    try {
        const projectCards = document.querySelectorAll('.card[data-project-id]');
        for (const card of projectCards) {
            const pid = card.getAttribute('data-project-id');
            const startedAt = Date.now();
            LAST_REQ_TS[pid] = startedAt;
            const url = `/api/project/${pid}/status?_=${Date.now()}`;
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) continue;
            const data = await res.json();

            let pct = parseInt(String(data.progress ?? 0), 10);
            if (Number.isNaN(pct)) pct = 0;
            pct = Math.max(0, Math.min(100, pct));
            const stage = data?.current_step ? String(data.current_step) : '';

            if (LAST_REQ_TS[pid] !== startedAt) continue;
            applyProgressToCard(card, pct, stage);

            const statusVal = (data?.status || '').toString().toLowerCase();
            if (pct === 100 && statusVal === 'completed') {
                card.classList.add('progress-complete');
            }
        }
    } catch (e) {
        console.error('Error refreshing progress:', e);
    }
}

function initProgressMonitoring() {
    refreshProgress();
    progressInterval = setInterval(refreshProgress, 5000);
}

// Clear intervals when leaving the page
window.addEventListener('beforeunload', () => {
    if (vulnerabilityCheckInterval) clearInterval(vulnerabilityCheckInterval);
    if (progressInterval) clearInterval(progressInterval);
});

// Single DOMContentLoaded bootstrap
document.addEventListener('DOMContentLoaded', function () {
    initVulnerabilityMonitoring();
    initProgressMonitoring();
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) refreshProgress();
    });
});

// (Other utility functions remain below)

        // Severity Alert Functions (from dashboard.html)
        function getSeverityAlertClass(severity) {
            switch(severity?.toLowerCase()) {
                case 'critical': return 'danger';
                case 'high': return 'warning';  
                case 'medium': return 'info';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }
        
        function getSeverityIcon(severity) {
            switch(severity?.toLowerCase()) {
                case 'critical': return 'ï¿½';
                case 'high': return 'ğŸ”´';
                case 'medium': return 'âš¡';
                case 'low': return 'ğŸ’¡';
                default: return 'ğŸ“‹';
            }
        }
        
        function getSeverityColor(severity) {
            switch(severity?.toLowerCase()) {
                case 'critical': return '#8b5cf6';  // Purple
                case 'high': return '#ef4444';      // Red
                case 'medium': return '#f97316';    // Orange
                case 'low': return '#059669';       // Green
                default: return '#6b7280';          // Gray
            }
        }
        
        function dismissVulnerabilityAlert(targetId) {
            fetch(`/api/targets/${targetId}/dismiss-alert`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Hide the alert visually
                    const alert = event.target.closest('.alert');
                    if (alert) {
                        alert.style.display = 'none';
                    }
                    console.log('Vulnerability alert dismissed for target:', targetId);
                }
            })
            .catch(error => {
                console.error('Error dismissing alert:', error);
            });
        }
        
        // Add missing functions for target actions
        function viewTarget(targetId) {
            window.location.href = `/project/{{ project.id }}/target/${targetId}`;
        }
        
        function scanTarget(targetId) {
            fetch(`/api/target/${targetId}/scan`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Scan started for target');
                        loadTargets(); // Refresh targets
                    }
                })
                .catch(error => console.error('Error starting scan:', error));
        }
        
        function deleteTarget(targetId) {
            if (confirm('Are you sure you want to delete this target?')) {
                fetch(`/api/target/${targetId}/delete`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadTargets(); // Refresh targets
                        }
                    })
                    .catch(error => console.error('Error deleting target:', error));
            }
        }
        
        // Load targets when page loads
        function loadTargets() {
            fetch(`/api/projects/{{ project.id }}/targets`)
                .then(response => response.json())
                .then(data => {
                    displayTargets(data.targets || []);
                })
                .catch(error => {
                    console.error('Error loading targets:', error);
                    const container = document.getElementById('targets-container');
                    if (container) {
                        container.innerHTML = '<div class="text-center"><p class="text-danger">Error loading targets</p></div>';
                    }
                });
        }

        // Enhanced displayTargets function with vulnerability alerts
        function displayTargets(targets) {
            const container = document.getElementById('targets-container');
            container.innerHTML = '';
            
            if (targets.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No targets found for this project.</p></div>';
                return;
            }
            
            targets.forEach(target => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                
                // Determine vulnerability classes
                let cardClasses = 'card h-100 position-relative';
                if (target.vulnerability_alert && target.max_severity) {
                    cardClasses += ` has-vulnerabilities vuln-${target.max_severity}`;
                }
                
                card.innerHTML = `
                    <div class="${cardClasses}" data-target-id="${target.id}">
                        <!-- Severity Alert Badge -->
                        ${target.vulnerability_alert ? `
                            <div class="vuln-badge ${target.max_severity || 'info'}">
                                ${getSeverityIcon(target.max_severity || 'info')} ${(target.max_severity || 'INFO').toUpperCase()}
                            </div>
                        ` : ''}
                        
                        <div class="card-body" onclick="viewTarget(${target.id});" style="cursor: pointer;">
                            <h5 class="card-title target-url">${target.target}</h5>
                            <p class="card-text">
                                <small class="text-muted">ğŸ§­ Type: ${target.type}</small><br>
                                <small class="text-muted">ğŸ“Š Status: ${target.status}</small>
                                ${target.vulnerability_alert ? `<br><small style="color: ${getSeverityColor(target.max_severity)};">ğŸš¨ ${target.vulnerability_count || 0} vulnerabilities found</small>` : ''}
                            </p>
                        </div>
                        
                        <div style="padding: 0 24px 24px;">
                            <div class="btn-group" role="group" style="width: 100%;">
                                <button class="btn btn-sm btn-primary" onclick="viewTarget(${target.id})" style="flex: 1;">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-success" onclick="scanTarget(${target.id})" style="flex: 1;">
                                    <i class="fas fa-search"></i> Scan
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTarget(${target.id})" style="flex: 1;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
</script>
</body>
</html>