{# templates/bugcrowd_list.html #}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Integraci√≥n con BugCrowd</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Mini estilos locales para que sea consistente con dashboard */
        .container { max-width: 1100px; margin: 24px auto; padding: 18px; color: #ddd; }
        .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        .card { background:#0f1720; border:1px solid #222; padding:16px; border-radius:10px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
        .card h3 { margin:0 0 8px 0; color:#ffb86b; font-size:1.05rem; }
        .muted { color:#9aa4ad; font-size:0.9rem; }
        .badge { display:inline-block; background:#123; color:#7ef0c7; padding:4px 8px; border-radius:6px; font-size:0.8rem; margin-left:8px; }
        .section { margin-top:14px; }
        .list { max-height:260px; overflow:auto; padding:8px; background:#071018; border-radius:6px; border:1px solid #18222b; }
        .list label { display:flex; gap:8px; align-items:center; padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,0.03); }
        .btn { background:#0ea5a4; color:#012; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn-outline { background:transparent; border:1px solid #264653; color:#9fd8d6; padding:7px 12px; border-radius:8px; cursor:pointer; }
        .header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
        .back { color:#7ef0c7; text-decoration:none; }

        .severity {
            font-weight: bold;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 5px;
        }

        .Critical { color: #ff4c9b; background:#3b002b; }
        .High     { color: #ff5b5b; background:#3b1b1b; }
        .Medium   { color: #facc15; background:#3a2f00; }
        .Low      { color: #4ade80; background:#0f2d1c; }
        .None     { color: #94a3b8; background:#1e293b; }
        .program-type-badge { 
            font-size:0.7rem; 
            font-weight:700; 
            padding:3px 8px; 
            border-radius:12px; 
            text-transform:uppercase; 
            letter-spacing:0.5px;
        }
        .program-type-badge.bbp { 
            background:linear-gradient(135deg, #7ef0c7, #0ea5a4); 
            color:#012; 
        }
        .program-type-badge.vdp { 
            background:linear-gradient(135deg, #ffb86b, #ff9d3d); 
            color:#012; 
        }
        .program-card.hidden { display: none; }
        
        .platform-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 6px 0 0 0;
        }
        
        .platform-logo {
            height: 40px;
            width: auto;
            object-fit: contain;
        }
        
        /* Invert dark logos for better visibility on dark background */
        .platform-logo[src*="hackerone-logo.svg"],
        .platform-logo[src*="bugcrowd-logo.png"],
        .platform-logo[src*="intigriti-logo.png"] {
            filter: invert(1) brightness(0.9);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a class="back" href="/dashboard">‚¨ÖÔ∏è Back to Dashboard</a>
                <div class="platform-header">
                    <img src="/static/img/bugcrowd-logo.png" alt="BugCrowd" class="platform-logo">
                </div>
                <p class="muted">üéØ Programs with Available Scope</p>
            </div>
        </div>

        {% if api_error %}
            <div class="card" style="border-left:4px solid #ff6b6b;">
                <strong>Error:</strong> {{ api_error }}
            </div>
        {% endif %}

        {% if not selected_program %}
        <!-- Filter Controls -->
        <div class="card" style="margin-bottom:16px; border-left:4px solid #ffb86b;">
            <h3 style="margin-bottom:12px; color:#ffb86b;">üîç Filters</h3>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                <div>
                    <label style="color:#ddd; font-size:0.9rem;">Program Type:</label>
                    <select id="programTypeFilter" style="margin-left:6px; padding:4px 8px; background:#161b22; color:#ddd; border:1px solid #21262d; border-radius:4px;">
                        <option value="">All Programs</option>
                        <option value="bbp">BBP (Bug Bounty)</option>
                        <option value="vdp">VDP (Vulnerability Disclosure)</option>
                    </select>
                </div>
                <div>
                    <label style="color:#ddd; font-size:0.9rem;">Min Targets:</label>
                    <input type="number" id="minTargetsFilter" min="0" placeholder="0" style="margin-left:6px; padding:4px 8px; background:#161b22; color:#ddd; border:1px solid #21262d; border-radius:4px; width:80px;">
                </div>
                <div>
                    <label style="color:#ddd; font-size:0.9rem;">Search:</label>
                    <input type="text" id="programSearchFilter" placeholder="Program name..." style="margin-left:6px; padding:4px 8px; background:#161b22; color:#ddd; border:1px solid #21262d; border-radius:4px; width:200px;">
                </div>
                <button onclick="clearFilters()" style="background:#ff6b86; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:0.85rem;">Clear Filters</button>
            </div>
        </div>
        {% endif %}

        <div class="grid" id="programsGrid">
            {% if not selected_program %}
                {% for p in programs %}
                <div class="card program-card" data-program-type="{{ 'bbp' if p.offers_bounties else 'vdp' }}" data-target-count="{{ p.domains_count + p.urls_count }}" data-program-name="{{ p.name|lower }}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <h3>üìÅ {{ p.name }}</h3>
                        <span class="program-type-badge {{ 'bbp' if p.offers_bounties else 'vdp' }}">
                            {{ 'BBP' if p.offers_bounties else 'VDP' }}
                        </span>
                    </div>
                    <div class="muted">Program ID: {{ p.handle }}</div>
                    {% if p.offers_bounties %}
                        <div style="margin:4px 0; color:#7ef0c7; font-size:0.85rem;">üí∞ Bug Bounty Program</div>
                    {% else %}
                        <div style="margin:4px 0; color:#ffb86b; font-size:0.85rem;">üîç Vulnerability Disclosure Program</div>
                    {% endif %}
                    <div style="margin-top:10px;">
                        Targets in Scope: {{ p.domains_count + p.urls_count }}
                        <span class="badge">üåê Dominios: {{ p.domains_count }}</span>
                        <span class="badge">üîó URLs: {{ p.urls_count }}</span>
                    </div>
                    <div class="section">
                        <form method="get" action="/import/bugcrowd/program/{{ p.handle }}">
                            <button type="submit" class="btn-outline">View and select targets</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                {# Left column: program summary #}
                <div class="card" style="grid-column: span 1;">
                    <h3>{{ selected_program.name }}</h3>
                    <div class="muted">Handle: {{ selected_program.handle }}</div>
                    {% if selected_program.url %}
                    <div class="muted"><a href="{{ selected_program.url }}" target="_blank">{{ selected_program.url }}</a></div>
                    {% endif %}
                    <div style="margin-top:10px;">
                        <span class="badge">Domains: {{ selected_program.domains_count }}</span>
                        <span class="badge">URLs: {{ selected_program.urls_count }}</span>
                    </div>

                    <div class="section">
                        <form id="scan-all-form" method="post" action="/import/bugcrowd/scan">
                            <input type="hidden" name="handle" value="{{ selected_program.handle }}">
                            <input type="hidden" name="name" value="{{ selected_program.name }}">
                            {# include all targets as hidden for scan-all #}
                            {% for t in selected_program.domains %}
                                <input type="hidden" name="targets" value="{{ t.clean }}">
                            {% endfor %}
                            {% for t in selected_program.urls %}
                                <input type="hidden" name="targets" value="{{ t.clean }}">
                            {% endfor %}
                            <button type="submit" class="btn" style="width:100%;">üöÄ Scan Entire Scope</button>
                        </form>
                    </div>
                </div>

                {# Right column: selector with checkboxes #}
                <div class="card" style="grid-column: span 2;">
                    <h3 style="color:#b8f3ea;">Select targets to scan</h3>
                    <p class="muted">Choose individual domains or URLs. Scroll inside the lists if long.</p>

                    <form id="selected-scan-form" method="post" action="/import/bugcrowd/scan">
                        <input type="hidden" name="handle" value="{{ selected_program.handle }}">
                        <input type="hidden" name="name" value="{{ selected_program.name }}">

                        <div class="section">
                            <strong style="color:#ffd27f;">Domains</strong>
                            <div class="list">
                                {% if selected_program.domains %}
                                    {% for d in selected_program.domains %}
                                        <label>
                                            <input type="checkbox" name="targets" value="{{ d.clean }}">
                                            <span style="flex:1">{{ d.original }}</span>
                                            <small class="muted">({{ d.clean }})</small>
                                            {% if d.severity and d.severity != 'none' %}
                                                <span class="severity {{ d.severity|capitalize }}">{{ d.severity|capitalize }}</span>
                                            {% endif %}
                                        </label>
                                    {% endfor %}
                                {% else %}
                                    <div class="muted">No domains in scope.</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="section">
                            <strong style="color:#ffd27f;">URLs</strong>
                            <div class="list">
                                {% if selected_program.urls %}
                                    {% for u in selected_program.urls %}
                                        <label>
                                            <input type="checkbox" name="targets" value="{{ u.clean }}">
                                            <span style="flex:1; word-break:break-all;">{{ u.original }}</span>
                                            <small class="muted">({{ u.clean }})</small>
                                            {% if u.severity and u.severity != 'none' %}
                                                <span class="severity {{ u.severity|capitalize }}">{{ u.severity|capitalize }}</span>
                                            {% endif %}
                                        </label>
                                    {% endfor %}
                                {% else %}
                                    <div class="muted">No URLs in scope.</div>
                                {% endif %}
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:14px;">
                            <button type="submit" class="btn">üöÄ Scan Selected</button>
                            <a class="btn-outline" href="/import/bugcrowd">‚Üê Back to list</a>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // small enhancement: if no checkbox selected when clicking scan selected, prevent submit
        document.addEventListener("DOMContentLoaded", function() {
            const selForm = document.getElementById("selected-scan-form");
            if (selForm) {
                selForm.addEventListener("submit", function(e) {
                    const checked = selForm.querySelectorAll('input[name="targets"]:checked');
                    if (!checked.length) {
                        e.preventDefault();
                        alert("Please select at least one target or use 'Scan Entire Scope'.");
                        return false;
                    }
                });
            }
        });

        // Filter functionality
        function applyFilters() {
            const typeFilter = document.getElementById('programTypeFilter').value;
            const minTargets = parseInt(document.getElementById('minTargetsFilter').value) || 0;
            const searchTerm = document.getElementById('programSearchFilter').value.toLowerCase();
            
            const cards = document.querySelectorAll('.program-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const programType = card.getAttribute('data-program-type');
                const targetCount = parseInt(card.getAttribute('data-target-count'));
                const programName = card.getAttribute('data-program-name');
                
                let shouldShow = true;
                
                // Type filter
                if (typeFilter && typeFilter !== programType) {
                    shouldShow = false;
                }
                
                // Min targets filter
                if (targetCount < minTargets) {
                    shouldShow = false;
                }
                
                // Search filter
                if (searchTerm && !programName.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (shouldShow) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });
            
            console.log(`Showing ${visibleCount} of ${cards.length} programs`);
        }

        function clearFilters() {
            document.getElementById('programTypeFilter').value = '';
            document.getElementById('minTargetsFilter').value = '';
            document.getElementById('programSearchFilter').value = '';
            applyFilters();
        }

        // Add event listeners for real-time filtering
        document.addEventListener('DOMContentLoaded', function() {
            const typeFilter = document.getElementById('programTypeFilter');
            const minTargetsFilter = document.getElementById('minTargetsFilter');
            const searchFilter = document.getElementById('programSearchFilter');
            
            if (typeFilter) typeFilter.addEventListener('change', applyFilters);
            if (minTargetsFilter) minTargetsFilter.addEventListener('input', applyFilters);
            if (searchFilter) searchFilter.addEventListener('input', applyFilters);
        });
    </script>
</body>
</html>